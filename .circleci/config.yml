# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

jobs:
  # Build the master branch of wla so we test with the latest version. So far
  # none of the stable releases of WLA actually build the disassembly properly.
  build-wla:
    docker:
      - image: stewmat/oracles-disasm-builder:0.1
    steps:
      - run: git clone https://github.com/vhelin/wla-dx
      - run: cd wla-dx
      - run: cd wla-dx; cmake .; make wla-gb wlalink
      - run: mkdir -p ~/bin; cp wla-dx/binaries/* ~/bin/
      - persist_to_workspace:
          root: ~/bin
          paths:
            - .
  build-game:
    docker:
      - image: stewmat/oracles-disasm-builder:0.1
    parameters:
      game:
        type: string
    steps:
      - checkout
      - attach_workspace:
          at: ~/bin
      - run: make << parameters.game >>


workflows:
  main:
    jobs:
      - build-wla
      - build-game:
          name: build-ages
          game: ages
          requires:
            - build-wla
      - build-game:
          name: build-seasons
          game: seasons
          requires:
            - build-wla
